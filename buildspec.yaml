version: 0.1

phases:
  install:
    commands:
      - echo "deb [trusted=yes arch=amd64] https://download.konghq.com/insomnia-ubuntu/ default all" | sudo tee -a /etc/apt/sources.list.d/insomnia.list
      - sudo apt-get update -y
      - sudo apt-get install insomnia -y
      - curl -sL https://github.com/Kong/insomnia/releases/download/lib%403.6.0/inso-linux-3.6.0.tar.xz -o inso-linux.xz
      - tar -xf inso-linux.xz
      - curl -sL https://github.com/kong/deck/releases/download/v1.16.1/deck_1.16.1_linux_amd64.tar.gz -o deck.tar.gz
      - tar -xf deck.tar.gz -C /tmp
      - sudo cp /tmp/deck /usr/local/bin/
      - deck version
      - ./inso --version
  build:
    commands:
      - inso export spec Petstore.yaml > Petstore.yaml
      - inso lint spec Petstore.yaml
      - inso generate config Petstore.yaml --type declarative > PetstoreKong.yaml
      - deck validate -s PetstoreKong.yaml
      - inso run test PetTestSuite
      - deck sync --kong-addr http://3.236.54.44:8001 --select-tag "Petstore" -s "PetstoreKong.yaml" --workspace "kongdemo" --headers "kong-admin-token:JUR0t0Y6e07JBw4sj87L0pIuEloQ9Rer"
      - curl -i -X PUT http://3.236.54.44:8001/kongdemo/files/specs/Petstore.yaml -F "contents=@Petstore.yaml" --header "kong-admin-token:JUR0t0Y6e07JBw4sj87L0pIuEloQ9Rer"
